#!/opt/lightshow/venv/bin/python
####################################################################################################
# python led_client.py rainbow
# python led_client.py blink red 10
# python led_client.py clear
####################################################################################################
import socket
import json
import sys
import logging
import argparse
import importlib
import presets

PORT = 8080  # Port of the server

def send_command(command):
    """Send a command to the LED service via socket."""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect(('localhost', PORT))  # Connect to the service running on localhost
        s.sendall(json.dumps(command).encode('utf-8'))

def create_command(animation, color="white", times=5):
    """Create a JSON command to control the LEDs."""
    command = {
        "animation": animation,
        "color": color,
        "times": times
    }
    return json.dumps(command)

def load_preset(preset):
    logging.debug(f"Loading preset {preset}")
    return getattr(presets, preset.upper())

def main(args):
    ## Command-line interface to send commands to the LED service
    #if len(sys.argv) < 2:
    #    print("Usage: python led_client.py <animation> [<color>] [<times>]")
    #    sys.exit(1)

    #animation = sys.argv[1]
    #color = sys.argv[2] if len(sys.argv) > 2 else "white"
    #times = int(sys.argv[3]) if len(sys.argv) > 3 else 5

    #command = create_command(animation, color, times)

    if args.preset:
        if args.preset == "off" or args.preset == "exit":
            command = {"show": args.preset}
        else:
            command = load_preset(args.preset)
        logging.debug(f"command = {command}")
    send_command(command)
    print(f"Sent command: {command}")


if __name__ == "__main__":
    colors = ["red",
              "yellow",
              "orange",
              "green",
              "teal",
              "cyan",
              "blue",
              "purple",
              "magenta",
              "white",
              "black",
              "gold",
              "pink",
              "aqua",
              "jade",
              "amber",
              "soft_white",
              "rainbow"
             ]
    animations = ["chase",
                  "colorcycle",
                  "comet",
                  "customcolorchase",
                  "rain",
                  "rainbowrain",
                  "matrixrain",
                  "multicolorcomet",
                  "pacman",
                  "pulse",
                  "rainbow",
                  "rainbowchase",
                  "rainbowcomet",
                  "rainbowsparkle",
                  "solid",
                  "sparkle",
                  "sparklepulse",
                  "volume",
                  "xmasrainbow"
                 ]
    preset_names = ["exit",
                    "off",
                    "rainbow",
                    "rainbowcomet",
                    "rainbowchase",
                    "usa",
                    "derry",
                    "hallowween",
                    "xmas",
                    "xmas2",
                    "xmasrainbow",
                    "xmasfast",
                    "xmas2faster",
                    "newyrs",
                    "xmasfade",
                    "stpatricksday"
                   ]

    parser = argparse.ArgumentParser(description="WS281X lightshow server")
    parser.add_argument('-d','--debug',action='store_true',help='enable debugging')
    parser.add_argument('-p','--preset',nargs='?',choices=preset_names,default=False,help="preset to use")
    parser.add_argument('--color',nargs='?',choices=colors,help="Color to set solid ('RED' or 'Color(255,0,0)')")
    parser.add_argument('--animation',nargs='?',choices=animations,help="Animation to set (requires --data)")
    parser.add_argument('--data',nargs='?',help="JSON string of show configurations")
    args = parser.parse_args()

    if args.debug:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    main(args)
